---
# Security Deployment Workflow - Critical deployment security checks
# This workflow performs comprehensive security validation for deployment readiness.
# It mirrors the Azure DevOps Scheduled stage security suite.
# Designed to run before critical deployments to ensure security posture compliance.
name: Security Deployment Validation

'on':
  workflow_call:
    inputs:
      max-age-days:
        description: 'Maximum age in days for dependency staleness check'
        required: false
        type: number
        default: 30
      break-build:
        description: 'Whether to break build on security findings'
        required: false
        type: boolean
        default: true
      iac-types:
        description: 'Infrastructure types to validate (all, terraform, bicep)'
        required: false
        type: string
        default: 'all'
  workflow_dispatch:
    inputs:
      max-age-days:
        description: 'Maximum age in days for dependency staleness check'
        required: false
        type: number
        default: 30
      break-build:
        description: 'Whether to break build on security findings'
        required: false
        type: boolean
        default: true
      iac-types:
        description: 'Infrastructure types to validate (all, terraform, bicep)'
        required: false
        type: string
        default: 'all'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # Security hardening setup for deployment validation
  security-hardening:
    name: Security Hardening Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Initialize security hardening
        run: |
          echo "Security hardening initialized for deployment validation"
          echo "Deployment security validation starting..."

  # SHA dependency staleness monitoring for supply chain security
  dependency-staleness:
    name: Dependency Staleness Check
    runs-on: ubuntu-latest
    needs: security-hardening
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Create logs directory
        shell: bash
        run: mkdir -p logs

      - name: Run dependency staleness check
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $MaxAge = [int]"${{ inputs.max-age-days }}"
          $BreakBuild = "${{ inputs.break-build }}" -eq "true"

          Write-Host "Running SHA staleness check with MaxAge=$MaxAge days, BreakBuild=$BreakBuild"

          ./scripts/security/Test-SHAStaleness.ps1 `
            -OutputFormat json `
            -MaxAge $MaxAge `
            -LogPath "./logs/sha-staleness-check.log" `
            -OutputPath "./stale-dependencies.json" `
            -ExitOnFailure $BreakBuild

          # Check for stale dependencies and fail if break-build is enabled
          if (Test-Path "./stale-dependencies.json") {
            $results = Get-Content "./stale-dependencies.json" | ConvertFrom-Json
            $staleCount = $results.TotalStaleItems

            if ($staleCount -gt 0) {
              Write-Warning "$staleCount stale dependencies found"
              if ($BreakBuild) {
                Write-Error "Build failed due to stale dependencies (break-build enabled)"
                exit 1
              }
            } else {
              Write-Host "All dependencies are within staleness threshold"
            }
          } else {
            Write-Error "Error: staleness check failed to generate results"
            exit 1
          }

      - name: Upload staleness results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dependency-staleness-results
          path: stale-dependencies.json
          retention-days: 30

  # OSSF Scorecard analysis for supply chain security assessment
  ossf-scorecard:
    name: OSSF Scorecard Analysis
    runs-on: ubuntu-latest
    needs: security-hardening
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Run OSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: false

      - name: Upload OSSF Scorecard results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ossf-scorecard-results
          path: scorecard-results.sarif
          retention-days: 30

      - name: Upload SARIF results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@fe4161a26a8629af62121b670040955b330f9af2
        with:
          sarif_file: scorecard-results.sarif

  # AIO version checking for deployment readiness
  aio-version-check:
    name: AIO Version Validation
    runs-on: ubuntu-latest
    needs: security-hardening
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run AIO version check
        run: |
          python scripts/aio-version-checker.py \
            --iac-type ${{ inputs.iac-types }} \
            --break-build ${{ inputs.break-build }} \
            --output-format json

      - name: Upload AIO version results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: aio-version-check-results
          path: aio-version-check-results.json
          retention-days: 30

  # Comprehensive security validation summary
  security-validation-summary:
    name: Security Validation Summary
    runs-on: ubuntu-latest
    needs: [security-hardening, dependency-staleness, ossf-scorecard, aio-version-check]
    if: always()
    timeout-minutes: 10
    steps:
      - name: Download all security artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: security-results

      - name: Generate security validation summary
        run: |
          echo "# Security Deployment Validation Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Job Results" >> security-summary.md
          echo "- Security Hardening: ${{ needs.security-hardening.result }}" >> security-summary.md
          echo "- Dependency Staleness: ${{ needs.dependency-staleness.result }}" >> security-summary.md
          echo "- OSSF Scorecard: ${{ needs.ossf-scorecard.result }}" >> security-summary.md
          echo "- AIO Version Check: ${{ needs.aio-version-check.result }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Deployment Security Status" >> security-summary.md

          if [[ "${{ needs.security-hardening.result }}" == "success" && \
                "${{ needs.dependency-staleness.result }}" == "success" && \
                "${{ needs.ossf-scorecard.result }}" == "success" && \
                "${{ needs.aio-version-check.result }}" == "success" ]]; then
            echo "✅ **DEPLOYMENT APPROVED**: All security validations passed" >> security-summary.md
            echo "deployment-approved=true" >> $GITHUB_OUTPUT
          else
            echo "❌ **DEPLOYMENT BLOCKED**: Security validation failures detected" >> security-summary.md
            echo "deployment-approved=false" >> $GITHUB_OUTPUT
            if [[ "${{ inputs.break-build }}" == "true" ]]; then
              exit 1
            fi
          fi

          cat security-summary.md

      - name: Upload security summary
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: security-deployment-summary
          path: security-summary.md
          retention-days: 90
