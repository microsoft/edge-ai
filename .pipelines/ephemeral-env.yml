# Ephemeral Build Pipeline

---
trigger:
  branches:
    include:
      - main

variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Main
    displayName: Deploy to Integration Env
    # dependsOn: string | [ string ]
    condition: eq(variables.isMain, true)
    # pool: string | pool
    # variables: { string: string } | [ variable | variableReference ]
    jobs:
      - job: ProviderRegistrationTest
        pool:
          vmImage: ubuntu-latest
        steps:
          # Unregister all required project resource providers to test registration process
          - task: AzureCLI@2
            displayName: Azure CLI for Provider Unregistration Script Run
            inputs:
              azureSubscription: 'azdo-ai-for-edge-iac-for-edge'
              workingDirectory: "$(System.DefaultWorkingDirectory)/src/000_rp_enablement"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                ./unregister-azure-providers.sh ./aio-azure-resource-providers.txt

          # Register all required project resource providers to test registration process
          - task: AzureCLI@2
            displayName: Azure CLI for Provider Registration Script Run
            inputs:
              azureSubscription: 'azdo-ai-for-edge-iac-for-edge'
              workingDirectory: "$(System.DefaultWorkingDirectory)/src/000_rp_enablement"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                ./register-azure-providers.sh ./aio-azure-resource-providers.txt

      - job: TerraformTest
        pool:
          vmImage: ubuntu-latest
        steps:

          # Initialize Terraform
          - task: TerraformInstaller@1
            displayName: install terraform
            inputs:
              terraformVersion: latest

          # Check version and output issue if needed
          - task: TerraformCLI@1
            displayName: 'Check terraform version'
            inputs:
              command: version

          # Run terraform init
          - task: TerraformCLI@1
            displayName: 'Terraform Init'
            inputs:
              command: init
              workingDirectory: "$(System.DefaultWorkingDirectory)/src/010_cluster_install/terraform/"
              runAzLogin: true
              environmentServiceName: 'azdo-ai-for-edge-iac-for-edge'
              backendType: azurerm
              # Service connection to authorize backend access. Supports Subscription & Management Group Scope
              backendServiceArm: 'azdo-ai-for-edge-iac-for-edge'
              backendAzureRmResourceGroupName: 'IaC_For_Edge'
              # azure location shortname of the backend resource group and storage account
              backendAzureRmResourceGroupLocation: 'eastus'
              backendAzureRmStorageAccountName: 'iacforedgetf'
              # azure blob container to store the state file
              backendAzureRmContainerName: 'iacforedgetf'
              # azure blob file name
              backendAzureRmKey: infrax.tfstate

          - task: TerraformCLI@1
            displayName: 'Terraform Validate'
            inputs:
              command: validate
              workingDirectory: "$(System.DefaultWorkingDirectory)/src/010_cluster_install/terraform/"

          # Run Terraform Plan for reporting
          - task: TerraformCLI@1
            displayName: 'Terraform Plan'
            inputs:
              command: plan
              workingDirectory: "$(System.DefaultWorkingDirectory)/src/010_cluster_install/terraform/"
              runAzLogin: true
              environmentServiceName: 'azdo-ai-for-edge-iac-for-edge'
              publishPlanResults: 'Terrafrom Test Plan'
              commandOptions: '-out=$(Build.ArtifactStagingDirectory)/$(Build.Buildnumber).tfplan
                -detailed-exitcode
                -var environment=$(TF_VAR_ENVIRONMENT)
                -var resource_prefix=$(TF_VAR_RESOURCE_PREFIX)
                -var location=$(TF_VAR_LOCATION)
                -var existing_resource_group_name=$(TF_VAR_EXISTING_RESOURCE_GROUP_NAME)
                -var vm_sku_size=$(TF_VAR_VM_SKU_SIZE)
                -var custom_locations_oid=$(TF_VAR_CUSTOM_LOCATIONS_OID)'

          - task: TerraformCLI@1
            displayName: 'Terraform Apply'
            inputs:
              command: apply
              environmentServiceName: 'azdo-ai-for-edge-iac-for-edge'
              # indicate az login should be run as part of this command
              runAzLogin: true
              commandOptions: '-detailed-exitcode
                -var environment=$(TF_VAR_ENVIRONMENT)
                -var resource_prefix=$(TF_VAR_RESOURCE_PREFIX)
                -var location=$(TF_VAR_LOCATION)
                -var existing_resource_group_name=$(TF_VAR_EPHEMERAL_RESOURCE_GROUP_NAME)
                -var vm_sku_size=$(TF_VAR_VM_SKU_SIZE)
                -var custom_locations_oid=$(TF_VAR_CUSTOM_LOCATIONS_OID)'

          - task: TerraformCLI@1
            displayName: 'Terraform Destroy'
            inputs:
              command: apply
              environmentServiceName: 'azdo-ai-for-edge-iac-for-edge'
              # indicate az login should be run as part of this command
              runAzLogin: true
              commandOptions: '-detailed-exitcode
                -var environment=$(TF_VAR_ENVIRONMENT)
                -var resource_prefix=$(TF_VAR_RESOURCE_PREFIX)
                -var location=$(TF_VAR_LOCATION)
                -var existing_resource_group_name=$(TF_VAR_EPHEMERAL_RESOURCE_GROUP_NAME)
                -var vm_sku_size=$(TF_VAR_VM_SKU_SIZE)
                -var custom_locations_oid=$(TF_VAR_CUSTOM_LOCATIONS_OID)'
