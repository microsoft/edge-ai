# GitHub Copilot with Prompt Files as Additional Context

Last updated: 2024-03-20

This document explores how to leverage GitHub Copilot's prompt files to enhance the development experience in the Accelerator project.
At time of writing, prompt files are available on Visual Studio Code Insiders version in experimental stage.

In addition to the [Copilot instructions file](../.github/copilot-instructions.md) which is automatically added to your Chat, Edits and Agent mode,
[prompt files](https://code.visualstudio.com/docs/copilot/copilot-customization#_reusable-prompt-files-experimental) provide additional context on design guidelines, domain knowledge, or reusable prompts that must be manually selected.

Before starting, review the Accelerator's [Readme.md](../README.md) and [Contributing.md](../CONTRIBUTING.md) files.
Familiarize yourself with the project's structure, [coding conventions](./coding-conventions.md), and guidelines.

> Note: GitHub Copilot features are constantly evolving. This document serves as a reference for the current
> state and will be updated as needed to reflect new improvements and additional features.

## Prerequisites

- [Visual Studio Code Insiders version](https://code.visualstudio.com/insiders/)
- [GitHub Copilot extension](https://marketplace.visualstudio.com/items/?itemName=GitHub.copilot)

## Using GitHub Copilot Prompt Files

Enable the [prompt files](https://docs.github.com/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot?tool=vscode#using-prompt-files) setting if this is not yet enabled in your VSCode Insiders settings:

```json
{
  "chat.promptFiles": true
}
```

This sets the default location for prompt files to the `.github/prompts` directory in your repository.
This directory currently contains a few prompt files for IaC and docs, which are used to provide context to GitHub Copilot when writing code or documentation.

### Setting the Prompt File Context

- When working on components or blueprints for IaC, set the context by clicking the `Add Context` button in the Copilot Chat panel.
- From the command palette, choose `Prompt ...`. This will display a list from the `.github/prompts` directory.
- Select the appropriate prompt file for the IaC language you are working with (Bicep or Terraform), or another available prompt file for generating documentation.
- Remember to remove the context when you switch to a different language or task.

### Example Prompts with Context for Bicep

The following process was used to create a Bicep IaC for a component that only exists in Terraform:

1. **Context Setup**:

   - Select **Copilot Edits** (Edit or Agent mode), a model like _Claude 3.7 Sonnet Thinking (Preview)_ or similar.
   - Ensure you select the right prompt file in the chat context (`bicep`). The prompt reference will be shown in the chat context textbox.
   - Select **Add Context**, then choose _Folder_ and type in `030-iot-ops-cloud-reqs` to select this component to set the context for the prompt.
   - This component already contains a Bicep implementation, so you can use the existing Bicep files as a reference for the new component.
   - Select **Add Context**, then choose _Folder_ and type `./050-vm-host` to select the sub-folder `./src/000-cloud/050-vm-host` and set context for the prompt. This is the component you want to convert from Terraform to Bicep (purely as an example).

2. **Initial Bicep Generation**:

   - Use this specific prompt for Copilot:

     ```text
     Look at bicep in 030-iot-ops-cloud-reqs, learn and follow guidelines, create a bicep version of 010-vm-host converting from terraform in ./src/000-cloud/050-vm-host/bicep. Follow prompt file guidance for Bicep conventions.
     ```

   - Depending on your Edits or Agent mode, Copilot will either generate the Bicep files or start a step-by-step process to create several files.
   - Bicep generated by Copilot typically still has invalid syntax and errors. Use the same context window to ask for additional iterations of changes until you are satisfied with the result.

3. **Refinement and Iteration**:

   - For example, if scopes are incorrect, or a resource is referenced as existing when it should be created, you can ask Copilot to fix this.
   - Prompt example after Copilot created separate Bicep files `main.bicep` and `main.resources.bicep`:

     ```text
     The resource group and subscription level split is not needed. The resource group should be a required parameter 'aioResourceGroup' 'name' which is retrieved with 'existing' resource for usage in the bicep
     ```

   - After this, initial Bicep is looking better but when we try deploying it, we see issues with idempotency of a `subnet` resource.
   - We can switch to **Ask** mode we can ask Azure Copilot to fix this, ensuring the `main.bicep` is in context.
   - We found a known issue which we also want to provide as Copilot context.
   - Select the **Add Context** button and select _Fetch Web Page_.
   - Prompt example:

     ```text
     @azure move the subnet into virtualNetwork resource and ensure the networkInterface references the subnet by id, due to issue https://github.com/Azure/bicep-types-az/issues/1687
     ```

   - Copilot suggested the following changes and solved the issue: Moved the `subnet` definition inside the `virtualNetwork` resource under the `subnets` property. Updated the `networkInterface` resource to reference the `subnet` by its ID using `${virtualNetwork.id}/subnets/subnet-${labelPrefix}`.

4. **Model Experimentation**:
   - Experiment with different models and see how typically _Claude 3.7 Sonnet_ or similar seems to be outperforming OpenAI GPT-4. Models are constantly evolving, so be sure to experiment with similar prompts at future times and adapt the prompt file to improve results.

### Example Prompts with Context for Terraform

The following process was used to add a `tags` variable to the component `./src/000-cloud/050-vm-host/terraform`:

1. **Context Setup**:

   - Select **Edit** or **Agent** mode, a model like _Claude 3.7 Sonnet Thinking (Preview)_ or similar.
   - Ensure you select the right prompt file in the chat context (`terraform`). The prompt reference will be shown in the chat context textbox.
   - Choose **Add Context** and type in `050-vm-host` to the Chat textbox to set the context for the prompt. This is the component you want to modify.

2. **Initial Terraform Generation**:

   - Use this specific prompt for Copilot:

     ```text
     Add a tags variable to the 050-vm-host/terraform component, add a test for this in ./tests/, include passing it in ./ci/ and include the tags variable in each resource that supports it.
     ```

   - Depending on your Edits or Agent mode, Copilot will either generate the Terraform files or start a step-by-step process to create several files.
   - Terraform generated by Copilot typically still has invalid syntax and errors. Use the same context window to ask for additional iterations of changes until you are satisfied with the result.

3. **Refinement and Iteration**:

   - For example, if the variables are not in alphabetical order, you can ask Copilot to fix this.
   - Prompt example after Copilot created the `tags` variable in the `variables.tf` file:

     ```text
     You did not correctly apply the reorder variables alphabetically when you edit any variables files.
     ```

4. **Model Experimentation**:
   - Experiment with different models, and be sure to experiment with similar prompts at future times and adapt the prompt file to improve results.

### Example Prompt Context to Generate AI Optimized Documentation

The following process was used to generate documentation for a set of files in the `./src/070-observability` folder:

1. **Context Setup**:

   - Select **Copilot Agent mode**, select a model like _Claude 3.7 Sonnet (Preview)_ or similar.
   - Ensure you select the right prompt file in the chat context (`generate-ai-docs`). The prompt reference will be shown in the chat context textbox.
   - Select **Add Context**, then choose _Folder_ and type `120-observability` to the Chat textbox to set the context for the prompt.
   - Or, open several files in the Editor and set the context _Add Context > Open Editors_.

2. **Initial Documentation Generation**:

   - Use this specific prompt for Copilot:

     ```text
     Generate documentation for the files in the ./src/000-cloud/020-observability folder.
     ```

   - Depending on your Edit or Agent mode, Copilot will either generate the documentation files or start a step-by-step process to create several files.
   - Documentation generated by Copilot typically still has errors or missing information. Use the same context window to ask for additional iterations of changes until you are satisfied with the result.

3. **Refinement and Iteration**:

   - For example, if the generated documentation is missing important details, you can ask Copilot to add them.
   - Prompt example after Copilot generated the initial documentation:

     ```text
     The generated documentation is missing details about the observability setup. Please add this information.
     ```

4. **Model Experimentation**:
   - Experiment with different models and see how typically _Claude 3.7 Sonnet_ or similar seems to be outperforming OpenAI GPT-4. Models are constantly evolving, so be sure to experiment with similar prompts at future times and adapt the prompt file to improve results.
