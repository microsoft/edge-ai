# GitHub Copilot with Custom Instructions Files

Last updated: 2025-04-29

This document explores how to leverage GitHub Copilot's custom instructions files to enhance the development experience in the Accelerator project.

The specialized instructions files in the [.github/instructions](/.github/instructions/) directory provide language-specific guidance to GitHub Copilot for IaC Terraform and Bicep development, C# coding, testing, Python scripting, and more. These files enhance the AI's understanding of the project's structure, conventions, and best practices.

We recommend attaching an instruction file to the context when working on a specific task:

- Use Copilot Chat: __Add Context > Instructions > Select the instructions {file}__ command
- Add your prompt specifics to the context, and then ask Copilot to work on your task
- Instructions files may also be automatically picked up by Copilot based on your current file's extension,
  thanks to the `applyTo` property that specifies which file types the instructions apply to

The default [Copilot instructions file](../.github/copilot-instructions.md) is automatically included in every chat request, while task-specific instruction files can be manually selected to provide additional guidance.

Before starting, review the Accelerator's [Readme.md](../README.md) and [Contributing.md](../CONTRIBUTING.md) files to familiarize yourself with the project's structure and [coding conventions](./coding-conventions.md).

> Note: GitHub Copilot features are constantly evolving. This document serves as a reference for the current
> state and will be updated as needed to reflect new improvements and additional features.

## Prerequisites

- [Visual Studio Code](https://code.visualstudio.com/insiders) (Insiders version recommended)
- [GitHub Copilot extension](https://marketplace.visualstudio.com/items/?itemName=GitHub.copilot)

## Using GitHub Copilot Instruction Files

This repository contains two types of instruction files:

1. __`.github/copilot-instructions.md`__: The default instruction file that's automatically included in every Copilot chat request

2. __`.instructions.md` files__: Task-specific instruction files in the `.github/instructions` directory that can be manually attached to your context

### Example Using Instruction Files for Bicep

The following process was used to create a Bicep IaC for a component that only exists in Terraform:

1. __Context Setup__:

   - Select Agent mode, a model like _Claude 3.7 Sonnet_ or similar.
   - Click __Add Context__ > __Instructions__ and select the `bicep` file. The instruction reference will be shown in the chat context area.
   - Select __Add Context__ again, then choose _Files & Folders_ and type in `030-iot-ops-cloud-reqs` to select this component to set the context for the conversation.
   - This component already contains a Bicep implementation, so you can use the existing Bicep files as a reference for the new component.
   - Select __Add Context__ again, then choose _Files & Folders_ and type `051-vm-host` to select the sub-folder `./src/000-cloud/051-vm-host` and set context for the conversation. This is the component you want to convert from Terraform to Bicep (purely as an example).

2. __Initial Bicep Generation__:

   - Use this specific prompt for Copilot:

     ```text
     Look at bicep in 030-iot-ops-cloud-reqs, learn and follow guidelines, create a bicep version of 010-vm-host converting from terraform in ./src/000-cloud/051-vm-host/bicep. Follow the bicep instruction guidance for conventions.
     ```

   - The attached instruction file ensures Copilot follows your team's Bicep coding standards automatically.
   - Bicep generated by Copilot typically still has invalid syntax and errors. Use the same context window to ask for additional iterations of changes until you are satisfied with the result.
   - As of writing, the context custom instructions may be lost so ensure to add it back via Add Context > Instructions > `bicep.instructions.md` if you need to ask for more changes.

3. __Refinement and Iteration__:

   - For example, if scopes are incorrect, or a resource is referenced as existing when it should be created, you can ask Copilot to fix this.
   - Prompt example after Copilot created separate Bicep files `main.bicep` and `main.resources.bicep`:

     ```text
     The resource group and subscription level split is not needed. The resource group should be a required parameter 'aioResourceGroup' 'name' which is retrieved with 'existing' resource for usage in the bicep
     ```

   - After this, initial Bicep is looking better but when we try deploying it, we see issues with idempotency of a `subnet` resource.
   - We can switch to __Ask__ mode we can ask Azure Copilot to fix this, ensuring the `main.bicep` is in context.
   - We found a known issue which we also want to provide as Copilot context.
   - Select the __Add Context__ button and select _Fetch Web Page_.
   - Prompt example:

     ```text
     @azure move the subnet into virtualNetwork resource and ensure the networkInterface references the subnet by id, due to issue https://github.com/Azure/bicep-types-az/issues/1687
     ```

   - Copilot suggested the following changes and solved the issue: Moved the `subnet` definition inside the `virtualNetwork` resource under the `subnets` property. Updated the `networkInterface` resource to reference the `subnet` by its ID using `${virtualNetwork.id}/subnets/subnet-${labelPrefix}`.

4. __Model Experimentation__:
   - Experiment with different models and see how typically _Claude 3.7 Sonnet_ or similar. Newest option with _GPT 4.1 (Preview)_ seems to be providing good results. Models are constantly evolving, so be sure to experiment with similar prompts at future times and adapt the instructions file to improve results.

### Example Prompts with Context for Terraform

The following process was used to add a `tags` variable to the component `./src/000-cloud/051-vm-host/terraform`:

1. __Context Setup__:

   - Select __Agent__ mode, a model like _Claude 3.7 Sonnet_ or similar.
   - Ensure you select the right instructions file in the chat context (`terraform`). The instructions file reference will be shown in the chat context textbox.
   - Choose __Add Context > Files & Folders__ and type in `051-vm-host` to the Chat textbox to set the context for the prompt. This is the component you want to modify.

2. __Initial Terraform Generation__:

   - Use this specific prompt for Copilot:

     ```text
     Add a tags variable to the 051-vm-host/terraform component, add a test for this in ./tests/, include passing it in ./ci/ and include the tags variable in each resource that supports it.
     ```

   - Depending on your Edits or Agent mode, Copilot will either generate the Terraform files or start a step-by-step process to create several files.
   - Terraform generated by Copilot typically still has invalid syntax and errors. Use the same context window to ask for additional iterations of changes until you are satisfied with the result.

3. __Refinement and Iteration__:

   - For example, if the variables are not in alphabetical order, you can ask Copilot to fix this.
   - Prompt example after Copilot created the `tags` variable in the `variables.tf` file:

     ```text
     You did not correctly apply the reorder variables alphabetically when you edit any variables files.
     ```

4. __Model Experimentation__:
   - Experiment with different models, and be sure to experiment with similar prompts at future times and adapt the prompt file to improve results.
