/**
 * Learning Paths Catalog Structure Tests
 * Validates auto-generated learning paths catalog structure
 * Tests aligned with new catalog architecture generated by Generate-LearningCatalog.ps1
 */

import { expect, describe, it, beforeAll } from 'vitest';
import { readFileSync } from 'fs';
import { join } from 'path';

describe('Learning Paths Catalog Structure', () => {
  const catalogPath = join(process.cwd(), '..', '..', '..', 'learning', 'paths', 'README.md');
  let content;

  beforeAll(() => {
    content = readFileSync(catalogPath, 'utf-8');
  });

  describe('YAML Frontmatter', () => {
    it('should contain valid YAML frontmatter', () => {
      // Strip BOM if present
      const normalizedContent = content.replace(/^\ufeff/, '');
      expect(normalizedContent).toMatch(/^---[\s\S]*?---/);
    });

    it('should have required frontmatter fields', () => {
      expect(content).toMatch(/title:/);
      expect(content).toMatch(/description:/);
      expect(content).toMatch(/author:/);
      expect(content).toMatch(/ms\.date:/);
      expect(content).toMatch(/ms\.topic:/);
      expect(content).toMatch(/keywords:/);
    });
  });

  describe('Auto-Generation Markers', () => {
    it('should contain auto-generated warning', () => {
      expect(content).toContain('AUTO-GENERATED');
      expect(content).toContain('DO NOT EDIT MANUALLY');
    });

    it('should reference generation script', () => {
      expect(content).toContain('Generate-LearningCatalog.ps1');
    });

    it('should have generation timestamp', () => {
      expect(content).toMatch(/Last updated: \d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/);
    });
  });

  describe('Learning Paths Content', () => {
    it('should contain signature learning paths section', () => {
      expect(content).toContain('Pre-Curated Learning Paths');
      expect(content).toContain('Signature learning paths');
    });

    it('should contain all 5 signature paths', () => {
      expect(content).toContain('Foundation: AI-First Engineering');
      expect(content).toContain('Intermediate: DevOps Excellence');
      expect(content).toContain('Intermediate: Infrastructure Architect');
      expect(content).toContain('Expert: Data & Analytics Integration');
      expect(content).toContain('Expert: Enterprise Integration Specialist');
    });

    it('should use checkbox list format for paths', () => {
      // Match both `- [ ] **` and `- [ ] [**` (linked paths with bold)
      const checkboxes = content.match(/- \[ \] \[?\*\*/g) || [];
      expect(checkboxes.length).toBeGreaterThanOrEqual(5);
    });

    it('should include path metadata (level indicators)', () => {
      expect(content).toContain('*Foundation*');
      expect(content).toContain('*Skill*');
      expect(content).toContain('*Expert*');
    });

    it('should include prerequisites information', () => {
      expect(content).toContain('**Prerequisites:**');
    });

    it('should include technologies information', () => {
      expect(content).toContain('**Technologies:**');
    });
  });

  describe('Markdown Format', () => {
    it('should not contain legacy dashboard elements', () => {
      expect(content).not.toContain('ðŸŒ±'); // Old Foundation Builder emoji
      expect(content).not.toContain('Foundation Builder'); // Old category name
      expect(content).not.toContain('Skill Developer'); // Old category name
      expect(content).not.toContain('Expert Practitioner'); // Old category name
      expect(content).not.toContain('Take Skill Assessment'); // Old CTA
      expect(content).not.toContain('Ready to Start Your Journey'); // Old CTA
    });

    it('should contain AI attribution footer', () => {
      expect(content).toContain('ðŸ¤–');
      expect(content).toContain('Copilot');
    });
  });
});
