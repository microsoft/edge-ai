---
title: MQTT to OpenTelemetry Trace Exporter
description: Rust service that ingests Azure IoT Operations MQTT messages and emits OpenTelemetry traces with Helm packaging for SAT and x509 authentication
author: Edge AI Team
ms.date: 10/16/2025
ms.topic: reference
keywords:
  - rust
  - mqtt
  - opentelemetry
  - azure iot operations
  - helm
estimated_reading_time: 12
---

## MQTT to OpenTelemetry Trace Exporter

The MQTT to OpenTelemetry Trace Exporter is a Rust service that subscribes to Azure IoT Operations (AIO) MQTT topics, enriches each message with correlation metadata, and emits trace spans to an OpenTelemetry collector. The component is packaged with a Helm chart that mounts Security Access Token (SAT) secrets by default and optionally enables x509 client certificates, allowing operators to deploy the exporter alongside Azure IoT Operations brokers.

## Architecture Overview

```ascii
┌──────────────────┐    MQTT v5 (QoS 1)    ┌────────────────────┐
│ Azure IoT Ops    │◀──shared subscription──│ MQTT Trace Exporter │
│ MQTT Broker      │                        │ (this component)    │
└──────────────────┘                        └─────────┬──────────┘
                                                     │
                                                     ▼
                                            ┌────────────────────┐
                                            │ OpenTelemetry       │
                                            │ Collector / Backend │
                                            └────────────────────┘
```

* Managed MQTT sessions reuse connections (`clean_start = false`) and persist cursors for durable delivery.
* Each message is parsed for a configurable correlation field; spans include payload metadata, acknowledgement outcome, and fallback details when correlation IDs are generated.
* Manual acknowledgements defer completion until processing succeeds; a heartbeat publisher confirms liveness on a derived topic.

## Prerequisites

* Kubernetes 1.25+ cluster with Azure IoT Operations MQTT broker access
* Helm 3.12 or later
* `kubectl` authenticated against the target cluster
* SAT token secret or x509 certificate material provisioned according to your AIO deployment

## Configuration

The exporter consumes configuration through environment variables surfaced by the Helm chart. Defaults favour the AIO quickstart broker but should be reviewed before production use.

### Environment Variables

| Variable                         | Purpose                                                                    | Default                      | Helm Value                              |
|----------------------------------|----------------------------------------------------------------------------|------------------------------|-----------------------------------------|
| `APP_LOG_LEVEL`                  | Structured log level used by `tracing-subscriber`.                         | `info`                       | `config.logLevel`                       |
| `OTEL_EXPORTER_OTLP_ENDPOINT`    | gRPC endpoint for OTLP trace export; spans are buffered until this is set. | _unset_                      | `config.telemetry.collectorEndpoint`    |
| `OTEL_SERVICE_NAME`              | Trace service name attribute.                                              | `mqtt-otel-trace-exporter`   | `config.telemetry.serviceName`          |
| `OTEL_SERVICE_NAMESPACE`         | Service namespace attribute.                                               | `edge-ai`                    | `config.telemetry.serviceNamespace`     |
| `OTEL_SERVICE_INSTANCE_ID`       | Service instance identifier (defaults to hostname/UUID).                   | autogenerated                | _optional override_                     |
| `OTEL_TRACES_SAMPLER_ARG`        | Trace sampling ratio (0.0-1.0).                                            | `1.0`                        | `config.telemetry.samplingRatio`        |
| `OTEL_BSP_MAX_EXPORT_BATCH_SIZE` | Max span batch size for OTLP exporter.                                     | `512`                        | `config.telemetry.maxExportBatchSize`   |
| `OTEL_BSP_MAX_QUEUE_SIZE`        | Span queue depth.                                                          | `2048`                       | `config.telemetry.maxQueueSize`         |
| `OTEL_BSP_SCHEDULE_DELAY`        | Background export interval (ms).                                           | `5000`                       | `config.telemetry.scheduledDelayMillis` |
| `OTEL_BSP_EXPORT_TIMEOUT`        | Export timeout (ms).                                                       | `30000`                      | `config.telemetry.exportTimeoutMillis`  |
| `MQTT_BROKER_HOST`               | MQTT broker hostname.                                                      | `mqtt-broker` (Helm default) | `config.mqtt.brokerHost`                |
| `MQTT_BROKER_PORT`               | MQTT broker TCP port.                                                      | `1883`                       | `config.mqtt.brokerPort`                |
| `MQTT_CLIENT_ID`                 | Explicit client identifier (UUID generated if omitted).                    | autogenerated                | `config.mqtt.clientId`                  |
| `MQTT_TOPIC_FILTERS`             | Comma-separated topic filters that will be wrapped in `$share/{group}/…`.  | `telemetry/#`                | `config.mqtt.topicFilters`              |
| `MQTT_SHARED_SUBSCRIPTION`       | Shared subscription group.                                                 | `edge-ai`                    | `config.mqtt.sharedSubscriptionGroup`   |
| `MQTT_SESSION_EXPIRY_SECS`       | Persistent session expiry.                                                 | `86400`                      | `config.mqtt.sessionExpirySecs`         |
| `MQTT_RECEIVE_MAX`               | Maximum in-flight QoS 1 messages.                                          | `128`                        | `config.mqtt.receiveMax`                |
| `MQTT_KEEP_ALIVE_SECS`           | Keep-alive interval.                                                       | `30`                         | `config.mqtt.keepAliveSecs`             |
| `MQTT_RETRY_MIN_BACKOFF_SECS`    | Minimum reconnect backoff.                                                 | `5`                          | `config.mqtt.retryMinBackoffSecs`       |
| `MQTT_RETRY_MAX_BACKOFF_SECS`    | Maximum reconnect backoff.                                                 | `60`                         | `config.mqtt.retryMaxBackoffSecs`       |
| `MQTT_SAT_TOKEN_PATH`            | Filesystem path to the SAT token secret.                                   | derived from mount           | managed by `satAuth`                    |
| `MQTT_CA_CERT_PATH`              | Filesystem path to broker CA bundle.                                       | derived from mount           | SAT or x509 secret configuration        |
| `MQTT_X509_CERT_PATH`            | Filesystem path to client certificate (when x509 enabled).                 | derived from mount           | managed by `x509Auth`                   |
| `MQTT_X509_KEY_PATH`             | Filesystem path to client key (when x509 enabled).                         | derived from mount           | managed by `x509Auth`                   |
| `CORRELATION_ID_FIELD`           | JSON pointer (dot-delimited) used to extract correlation IDs.              | `correlationId`              | `config.correlation.fieldName`          |
| `CORRELATION_ALLOW_GENERATED`    | Whether to generate UUIDs when the field is missing or invalid.            | `true`                       | `config.correlation.allowGenerated`     |

### Helm Values Highlights

The chart values file (`charts/mqtt-otel-trace-exporter/values.yaml`) exposes the following top-level sections:

* `replicaCount`: Controls the number of exporter pods participating in a shared subscription group.
* `image`: Repository, tag, and pull policy for the container image.
* `satAuth`: Enables SAT token mounting without additional overrides; set `create=true` to generate a secret from supplied values.
* `x509Auth`: Optional client certificate support with similar secret generation controls.
* `config`: Mirrors application environment variables, rendered into a ConfigMap consumed via `envFrom`.
* `extraEnv` / `extraVolumes`: Extensibility hooks for advanced Kubernetes integrations.

Review the chart README and `values.yaml` to tailor deployments to your cluster policies.

## Authentication and Secrets

### SAT Authentication (default)

* When `satAuth.enabled=true`, the deployment mounts the secret named in `satAuth.secretName` at `satAuth.mountPath` and sets `MQTT_SAT_TOKEN_PATH` automatically.
* If your cluster operator provisions tokens, set `satAuth.create=false` and point `satAuth.secretName` at the managed secret containing keys `sat.token` and, optionally, `ca.crt`.
* For development scenarios you can embed placeholder data by setting `satAuth.create=true` and supplying `satAuth.secret.token` / `satAuth.secret.caCert` values (base64 encoding handled by the template).

### x509 Client Certificates (optional)

* Enabling `x509Auth.enabled=true` mounts a TLS secret with certificate/key pairs at `x509Auth.mountPath` and exports `MQTT_X509_CERT_PATH` / `MQTT_X509_KEY_PATH`.
* Provide an external secret via `x509Auth.secretName` or allow the chart to generate one by setting `x509Auth.create=true` and populating `x509Auth.secret` values.
* If both SAT and x509 are active, the deployment prioritizes the CA bundle from the x509 secret; ensure the files are consistent.

## Deployment

### Install or Upgrade via Helm

```bash
helm upgrade --install mqtt-otel-trace-exporter \
  src/500-application/504-mqtt-otel-trace-exporter/charts/mqtt-otel-trace-exporter \
  --namespace aio-observability \
  --create-namespace \
  --set image.tag=2025.10.16 \
  --set config.telemetry.collectorEndpoint="http://otel-collector:4317"
```

* Replace `image.repository` and `image.tag` with the container published to your registry.
* Ensure `config.mqtt.brokerHost` targets your AIO broker service (for the quickstart broker, use `aio-mqtt:18883` and enable SAT or x509 according to your cluster secrets).

### Verifying the Deployment

```bash
kubectl get pods -n aio-observability -l app.kubernetes.io/name=mqtt-otel-trace-exporter
kubectl logs deployment/mqtt-otel-trace-exporter -n aio-observability -c mqtt-otel-trace-exporter
```

* Logs tagged with `target="mqtt"` confirm subscription and acknowledgement progress.
* Spans appear in the configured collector backend with attributes such as `messaging.destination`, `messaging.message_payload_size_bytes`, and `correlation.id`.

## Scaling Guidance

* Increase `replicaCount` to scale horizontally; shared subscriptions (`$share/{group}/topic`) distribute messages across replicas while maintaining at-least-once delivery.
* Tune `MQTT_RECEIVE_MAX` to match concurrency requirements; ensure it aligns with downstream throughput to avoid backlog.
* Adjust `MQTT_SESSION_EXPIRY_SECS` when replicas are frequently rescheduled to balance redelivery latency with broker resource usage.
* Exporter pods emit heartbeat publishes derived from the first topic filter (e.g., `telemetry/heartbeat`); monitor this topic to confirm liveness across replicas.

## Troubleshooting

* **No spans exported**: Confirm `config.telemetry.collectorEndpoint` points to a reachable OTLP gRPC endpoint and that network policies allow traffic. The application logs a warning when the endpoint is unset.
* **Authentication failures**: Verify the SAT or x509 secrets are mounted with correct key names. For SAT tokens provisioned by Azure IoT Operations, ensure `satAuth.secretName` references the projected volume containing `sat.token`.
* **Message processing errors**: Inspect logs for `Failed to process publish` messages. Invalid correlation payloads fall back to generated IDs when `config.correlation.allowGenerated=true`; set this to `false` to fail fast during validation.
* **Repeated redelivery**: Manual acknowledgements defer completion until the `ack()` future resolves. Investigate downstream latency or exporter crashes if duplicates accumulate, and review retry backoff settings.

## Related Resources

* Azure IoT Operations MQTT guidance: <https://learn.microsoft.com/azure/iot-operations/overview-mqtt>
* OpenTelemetry Collector deployment patterns: <https://opentelemetry.io/docs/collector/>
* Azure IoT Operations SDK for Rust samples: <https://github.com/Azure/iot-operations-sdks>
