---
title: ROS2 Connector & Simulator
description: ROS2 Jazzy connector with dynamic topic discovery, Cyclone DDS config, custom interface build, optional simulator, and MQTT bridge
author: Edge AI Team
ms.date: 09/24/2025
ms.topic: reference
keywords:
    - ros2
    - robotics
    - simulation
    - connector
    - edge-ai
estimated_reading_time: 5
---

## ROS2 Connector & Simulator

### Quick Summary

Bridges live ROS 2 Jazzy topics into an in-cluster MQTT broker as structured JSON.
Uses Cyclone DDS (XML + env overrides).
Can optionally run with host networking so the container participates directly on a LAN DDS domain,
enabling bridging of ROS 2 publishers that are running on a different physical machine (same network).

Compact ROS2 (Jazzy) toolkit:

- Dynamic topic discovery + include/exclude filtering
- Pluggable message handlers (drop‑in Python classes)
- Cyclone DDS config via mounted XML + peer/interface env vars
- Example custom interface package (`edge_ros_interface`) built with `colcon`
- Optional simulator (synthetic publishers or bag playback)
- MQTT JSON bridge (anonymous broker only)

## 1. Directory

```text
src/500-application/506-ros2-connector/
├── README.md                         # Main documentation
├── .env                              # Runtime environment overrides (generated by generate-env-config.sh and git ignored)
├── .gitignore                        # Git ignore rules for this app
├── docker-compose.yml                # Core services: connector, simulator, MQTT broker
├── charts/                           # Helm chart for k8s deployment
│   └── ros2-connector/
│       ├── Chart.yaml
│       ├── values.yaml               # Helm values (env, images, resources)
│       └── templates/                # K8s manifests (deployment, svc, configmap, etc.)
├── services/                         # Container build contexts
│   ├── Dockerfile                    # (Root) optional shared base (if used by scripts)
│   ├── requirements.txt              # (Root) consolidated requirements (if used)
│   ├── ros2-connector/               # ROS2 dynamic topic bridge service
│   │   ├── Dockerfile                # Multi-stage image builds custom interfaces
│   │   ├── requirements.txt          # Connector Python deps
│   │   └── src/
│   │       ├── ros2_connector.py     # Main application node
│   │       └── message_types/        # Pluggable message handlers
│   │           ├── base_handler.py
│   │           ├── string_handler.py
│   │           ├── joint_state_handler.py
│   │           ├── compressed_image_handler.py
│   │           ├── metrics_handler.py
│   │           └── registry.py
│   └── ros2-simulator/               # Synthetic publisher & (optional) bag player
│       ├── Dockerfile
│       ├── README.md
│       ├── requirements.txt
│       └── src/
│           ├── ros2_simulator.py     # Procedural topic publisher
│           └── ros2_bag_player.py    # MCAP bag playback utility
├── resources/                        # Static config & custom interfaces
│   ├── cyclone-dds-local.xml         # Local docker-compose Cyclone DDS config (static peers)
│   ├── cyclone-dds.xml               # Cluster placeholder (Helm-generated configmap overrides)
│   ├── mosquitto.conf                # MQTT broker configuration
│   ├── data/                         # (Optional) Raw bag / sample data input (contents are git ignored)
│   └── ros-interfaces/
│       └── edge-ros-interface/       # Custom ROS2 interface package source
│           ├── CMakeLists.txt
│           ├── package.xml
│           └── msg/
│               ├── Metrics.msg
│               └── MetricValue.msg
├── scripts/                          # Build & deploy helpers
│   ├── build-ros-img.sh              # Builds connector + simulator images
│   ├── deploy-ros2-connector.sh      # Deploy connector to cluster
│   ├── deploy-ros2-simulator.sh      # Deploy simulator to cluster
│   └── generate-env-config.sh        # Generate / update .env
├── docs/                             # (If populated) Additional design/use docs
└── yaml/                             # (Reserved) Raw manifest examples (currently empty)

```

## 2. Flow

```text
ROS2 topics (simulator / external) → discovery + handler + JSON pipeline → MQTT
```

Components:

1. ros2-connector – discovers & bridges
2. ros2-simulator – synthetic or bag playback (mutually exclusive modes)

## 3. Configuration (Key Env Vars)

Generate full list: `./scripts/generate-env-config.sh` (adds missing defaults, preserves edits).

```bash
# Generate .env
cd src/500-application/506-ros2-connector
./scripts/generate-env-config.sh   # creates / updates .env
```

Core runtime vars:

| Variable                 | Purpose                                         |
|--------------------------|-------------------------------------------------|
| `ROS_DOMAIN_ID`          | Domain ID (all participants must match)         |
| `RMW_IMPLEMENTATION`     | RMW layer (`rmw_cyclonedds_cpp`)                |
| `TOPIC_FILTER_PATTERNS`  | Glob(s) for inclusion (default `*`)             |
| `EXCLUDE_SYSTEM_TOPICS`  | Hide system topics (`true`/`false`)             |
| `ROS_LOCALHOST_ONLY`     | `1` loopback only, `0` normal networking        |
| `CYCLONEDDS_PEERS`       | Peer list (e.g. `ros2-simulator`)               |
| `CYCLONEDDS_INTERFACES`  | Network interfaces (e.g. `eth0`)                |
| `USE_HOST_NETWORK`       | Use host network for ROS2 (`true`/`false`)      |
| `SIMULATOR_PUBLISH_RATE` | Hz for synthetic messages                       |
| `USE_BAG_PLAYBACK`       | `true` = bag playback mode (disables synthetic) |
| `BAG_PATH`               | Path inside container to bag data               |
| `MQTT_BROKER`            | MQTT host (anonymous broker only)               |
| `MQTT_PORT`              | MQTT port (default `1883` in compose)           |
| `MQTT_TOPIC_PREFIX`      | Prefix for emitted MQTT topics                  |
| `LOG_LEVEL`              | `INFO` / `DEBUG`                                |

Additional deployment vars (`ACR_NAME`, images, PVC, namespace, etc.) are auto-inserted into `.env` but omitted here for brevity.

### MQTT Topic Construction

All MQTT topics published by the connector are derived from the ROS2 topic name using this pattern:

```text
<MQTT_TOPIC_PREFIX>/<handler_type><ros_topic_with_slashes_replaced_by_underscores>
```

Where:

- `MQTT_TOPIC_PREFIX` provides a namespace boundary (e.g. `edge`, `robot`, `prod`, etc.)
- `handler_type` is a short identifier defined by the message handler (e.g. `string`, `joint_state`, `image`, `metrics`)
- The original ROS2 topic (e.g. `/camera/color/image_raw/compressed`) is transformed by replacing `/` with `_` -> `_camera_color_image_raw_compressed`

Example:

```text
ROS2 topic: /camera/color/image_raw/compressed
Prefix: edge
Handler type: image
Final MQTT topic: edge/image_camera_color_image_raw_compressed
```

Mutually exclusive modes:

- Synthetic (default) uses `SIMULATOR_PUBLISH_RATE`
- Bag playback (`USE_BAG_PLAYBACK=true`)

## 4. Local Testing (Docker Compose)

Build images (compose directly):

```bash
# Standard service image build
docker compose build

# Start connector + simulator + broker (detached)
docker compose up -d

# List container states
docker compose ps

# Stop & remove
docker compose down

# Health
curl http://localhost:8080/health
```

Disable simulator (run only broker + connector):

```bash
docker compose up -d mqtt-broker ros2-connector
```

Common commands:

```bash
docker compose exec ros2-connector bash -c "source /opt/ros/jazzy/setup.bash && ros2 topic list"
docker compose exec ros2-connector bash -c "source /opt/ros/jazzy/setup.bash && ros2 topic echo /chatter"
docker compose logs -f ros2-connector

# mqtt-ui
docker compose exec mqtt-ui sh
mqttui -b mqtt://mqtt-broker:1883
```

### ROS2 Bag Playback (.mcap)

Play back a recorded ROS2 bag (MCAP format) instead of synthetic topics using the simulator container.

Folder layout (place under `resources/data/` – contents are git ignored):

```text
resources/
  data/
     demo_bag/                # Bag directory name (arbitrary)
        metadata.yaml          # Required rosbag2 metadata
        <chunk_0>.mcap         # One or more .mcap files
        <chunk_1>.mcap
```

Steps:

1. Copy or extract your bag folder into `resources/data/` (it must contain `metadata.yaml` + `.mcap`).
2. Set (or append) in `.env`:

    ```bash
    USE_BAG_PLAYBACK=true
    BAG_PATH=/app/data/demo_bag   # Match your bag directory name
    ```

    (The compose file mounts `./resources/data` to `/app/data` read‑only.)

Notes:

- Synthetic publishing is automatically disabled when `USE_BAG_PLAYBACK=true`.
- Change `BAG_PATH` to point at a different bag directory without rebuilding images.

## 5. Deployment (Kubernetes)

```bash
# Connect to az k8s proxy
az connectedk8s proxy -n <cluster-name> -g <resource-group>

# Deploy connector (Uses .env to apply config to helm chart)
./scripts/deploy-ros2-connector.sh

# Deploy Optional simulator (Uses .env to apply config to helm chart)
./scripts/deploy-ros2-simulator.sh
```

### Bag Playback Deployment (Simulator)

When `USE_BAG_PLAYBACK=true` the simulator deploy script can automatically:

1. Ensure / create a PersistentVolumeClaim (PVC) (`PVC_NAME`, default `rosbag-pvc`).
2. (Optionally) Copy your local bag directory contents (`metadata.yaml` + `.mcap`) into the PVC if you provide `LOCAL_PATH`.
3. Mount that PVC into the simulator pod at `TARGET_PATH` (default `/app/data`) so the container sees the bag at the `BAG_PATH` you set (commonly `/app/data/<bag_dir>` in `.env`).

Prepare:

```text
resources/
    data/
        demo_bag/
            metadata.yaml
            <chunks>.mcap
```

Add to `.env` (example):

```bash
USE_BAG_PLAYBACK=true
BAG_PATH=/app/data/demo_bag      # Inside container path expected by ros2_bag_player
```

Run deployment passing a local source path so it is uploaded into the PVC (path is relative to component root when prefixed with `/resources`):

```bash
ACR_NAME=<registry> USE_BAG_PLAYBACK=true LOCAL_PATH=/resources/data/demo_bag ./scripts/deploy-ros2-simulator.sh
```

Key env knobs (override in shell or `.env`):

| Variable           | Purpose                                                         |
|--------------------|-----------------------------------------------------------------|
| `USE_BAG_PLAYBACK` | Gate to enable PVC + copy + playback                            |
| `LOCAL_PATH`       | Local relative path (e.g. `/resources/data/demo_bag`) to upload |
| `PVC_NAME`         | PVC name (default `rosbag-pvc`)                                 |
| `PVC_SIZE`         | Requested storage size (default `5Gi`)                          |
| `TARGET_PATH`      | Mount path inside loader + simulator pod (default `/data`)      |
| `BAG_PATH`         | Path the player reads (often `/app/data/<bag_dir>`)             |

Notes:

- Large bag directories (>2GB or files >1GB) are streamed with `tar` for reliability.
- Re-run the deploy script to update bag contents after changes.

## 6. Message Handlers

| ROS2 Type                       | Handler Class                 | MQTT type   |
|---------------------------------|-------------------------------|-------------|
| std_msgs/msg/String             | StringMessageHandler          | string      |
| sensor_msgs/msg/JointState      | JointStateMessageHandler      | joint_state |
| sensor_msgs/msg/CompressedImage | CompressedImageMessageHandler | image       |
| edge_ros_interface/msg/Metrics  | MetricsMessageHandler         | metrics     |

Add a handler:

1. Create `services/ros2-connector/src/message_types/<your>_handler.py`
2. Implement subclass of `BaseMessageHandler` with: `message_type`, `message_class`, `handler_type`, `handle_message`
3. Rebuild: `docker compose build ros2-connector` (or `./scripts/build-ros-img.sh`)
4. Restart connector – registry auto-discovers by module import

Skeleton:

```python
from geometry_msgs.msg import PoseStamped
from . import base_handler

class PoseMessageHandler(base_handler.BaseMessageHandler):
    @property
    def message_type(self): return 'geometry_msgs/msg/PoseStamped'
    @property
    def message_class(self): return PoseStamped
    @property
    def handler_type(self): return 'pose'
    def handle_message(self, msg, topic_name, logger, mqtt_publisher):
        data = self.create_base_mqtt_data(topic_name)
        data.update({
            'position': {'x': msg.pose.position.x, 'y': msg.pose.position.y, 'z': msg.pose.position.z},
            'orientation': {
                'x': msg.pose.orientation.x, 'y': msg.pose.orientation.y,
                'z': msg.pose.orientation.z, 'w': msg.pose.orientation.w
            }
        })
        self.publish_to_mqtt(topic_name, data, mqtt_publisher)
```

## 7. Custom Interfaces

Example package: `resources/ros-interfaces/edge-ros-interface`.

Create your own:

1. Copy example folder to a new sibling (e.g. `my-ros-interface`)
2. Update `package.xml` & `CMakeLists.txt` names
3. Add `.msg` / `.srv` / `.action` files under `msg/` (and adjust build lists)
4. Rebuild images (`./scripts/build-ros-img.sh`) – Dockerfiles collect & build via `colcon`
5. Implement handler(s) if publishing to MQTT

## 8. Cyclone DDS

Cyclone DDS Configuration:

- Local: edit `resources/cyclone-dds-local.xml` (static peers / interfaces)
- Kubernetes: chart mounts a ConfigMap with the rendered `cyclone-dds.xml`
- Use `CYCLONEDDS_PEERS` / `CYCLONEDDS_INTERFACES` for simple peer/interface control
- Override URI (advanced) by modifying compose or Helm values to point `CYCLONEDDS_URI`

### Large Message Socket Buffers (Optional)

High‑bandwidth topics (e.g. compressed images or large point clouds) can exceed default Linux UDP socket buffer limits,
causing dropped samples or DDS reliability warnings. Temporarily raise the kernel limits (effective until reboot):

```bash
sudo sysctl -w net.core.rmem_max=268435456
sudo sysctl -w net.core.wmem_max=268435456

# To persist after restarts
sudo tee /etc/sysctl.d/99-ros2-buffers.conf >/dev/null <<'EOF'
net.core.rmem_max=268435456
net.core.wmem_max=268435456
net.core.rmem_default=4194304
net.core.wmem_default=4194304
EOF
sudo sysctl --system  # # Reload all sysctl configs

```

Only increase as needed; oversized buffers consume kernel memory.

## 9. Troubleshooting

| Symptom              | Quick Check                                                                                              | Fix                                                           |
|----------------------|----------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
| No topics discovered | `docker compose exec ros2-connector bash -c "source /opt/ros/jazzy/setup.bash && ros2 topic list"` empty | Ensure matching `ROS_DOMAIN_ID`, verify Cyclone DDS XML peers |
| MQTT not receiving   | Connector logs show publish?                                                                             | Check `MQTT_BROKER` host & network                            |
| Health endpoint down | Container restarting                                                                                     | `docker compose logs ros2-connector` for stack trace          |
| Bag playback silent  | `USE_BAG_PLAYBACK` set?                                                                                  | Confirm `BAG_PATH` mounted and contains valid bag             |

Enable debug:

```bash
echo "LOG_LEVEL=DEBUG" >> .env && docker compose restart ros2-connector
```

---

generated by ai, reviewed with love by real humans
