---
services:

  mosquitto-broker:
    image: eclipse-mosquitto:2.0.18
    container_name: sse-mosquitto-broker
    ports:
      - "11883:1883"
      - "19001:9001"
    volumes:
      - "./resources/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro"
      - "mosquitto-data:/mosquitto/data"
    networks:
      - akri-sse-connector
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "mosquitto_sub",
          "-h",
          "localhost",
          "-t",
          "$$SYS/broker/uptime",
          "-C",
          "1"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  sse-server:
    image: ${REGISTRY:-local}/${APPLICATION:-sse-connector}/sse-server:${BUILD_ID:-latest}
    build:
      context: ./services/sse-server
      dockerfile: Dockerfile
    container_name: sse-server
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DEVICE_ID=analytics-camera-001
      - HEARTBEAT_INTERVAL=5
      - ALERT_PROBABILITY=0.1
    networks:
      - akri-sse-connector
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  connector-test-client:
    image: ${REGISTRY:-local}/${APPLICATION:-sse-connector}/connector-test-client:${BUILD_ID:-latest}
    build:
      context: ./services/connector-test-client
      dockerfile: Dockerfile
    container_name: sse-connector-test-client
    environment:
      - AIO_MQTT_USE_TLS=false
      - AIO_MQTT_CLIENT_ID=akri-sse-connector-test
      - AIO_BROKER_HOSTNAME=mosquitto-broker
      - AIO_BROKER_TCP_PORT=1883

      - SSE_ENDPOINT=http://sse-server:8080/camera-events

      - TOPIC_HEARTBEAT=camera-events/heartbeat
      - TOPIC_ALERT=camera-events/alert
      - TOPIC_ALERT_DLQC=camera-events/alert_dlqc
      - TOPIC_ANALYTICS_ENABLED=camera-events/analytics_enabled
      - TOPIC_ANALYTICS_DISABLED=camera-events/analytics_disabled
      - ERROR_TOPIC=akri/sse-connector/errors

    depends_on:
      mosquitto-broker:
        condition: service_healthy
      sse-server:
        condition: service_healthy

    networks:
      - akri-sse-connector
    restart: unless-stopped

  mqtt-monitor:
    image: eclipse-mosquitto:2.0.18
    container_name: sse-mqtt-monitor
    command: |
      sh -c "
        echo 'Starting MQTT Monitor for SSE Connector...'
        echo 'Subscribing to camera-events/# topics...'
        mosquitto_sub -h mosquitto-broker -t 'camera-events/#' -v
      "
    depends_on:
      mosquitto-broker:
        condition: service_healthy
    networks:
      - akri-sse-connector
    restart: unless-stopped

networks:
  akri-sse-connector:
    driver: bridge
    name: akri-sse-connector

volumes:
  mosquitto-data:
    name: akri-sse-connector-mosquitto-data
