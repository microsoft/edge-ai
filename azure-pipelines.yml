# Azure DevOps CI/CD Pipeline
#
# Purpose:
# This pipeline automates the build, test, and deployment processes for IaC components,
# ensuring consistent quality and validation before deployment to production environments.
#
# Functionality:
# - Runs on pull requests and commits to main branch
# - Dynamically detects changes and determines which components to validate
# - Executes matrix-based Terraform testing for affected infrastructure components
# - Validates PowerShell and shell scripts for resource provider operations
# - Performs infrastructure validation using custom test harnesses
#
# Parameters:
# - None directly in this file, but parameters are passed to templates
#
# Output Variables:
# - None directly, outputs are managed by individual template stages
#
# Usage Examples:
# This pipeline runs automatically on PR creation and merges to main.
# It can also be manually triggered through the Azure DevOps interface.
#
# This pipeline is the primary CI/CD process for the Edge infrastructure components,
# ensuring quality before any changes reach production environments.

---
trigger:
  branches:
    include:
      - dev
      - internal-eng
      - pre-release

# Add parameters section for manual trigger option
parameters:
  - name: RunSecurityUpdateScanning
    displayName: 'Run Security and Update Scanning'
    type: boolean
    default: false
  # Control matrix generation behavior
  - name: IncludeAllApplications
    displayName: 'Include All Applications (Ignore Changes)'
    type: boolean
    default: false
  - name: IncludeAllIaC
    displayName: 'Include All IaC Folders in Matrix Detection'
    type: boolean
    default: false
  - name: PullRequestIdOverride
    displayName: 'Pull Request ID Override (for manual triggers, leave empty for auto-detection)'
    type: string
    default: 'e.g., 12345 (enter PR number or leave empty)'

schedules:
  - cron: "0 5 * * *"
    displayName: Daily 9 PM PST/5 AM UTC Trigger
    branches:
      include:
        - dev
    always: true

# set isMain to true if the branch is main to trigger main stage
# set isPreRelease to true if the branch is pre-release to trigger pre-release stage
# set isScheduled to true if the build is scheduled to trigger
variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/dev')]
  isPreRelease: $[eq(variables['Build.SourceBranch'], 'refs/heads/pre-release')]
  isScheduled: $[eq(variables['Build.Reason'], 'Schedule')]
  # Use parameter override if provided, otherwise use system variable
  pullRequestIdOverride: ${{ parameters.PullRequestIdOverride }}
  includeAllApplications: ${{ parameters.IncludeAllApplications }}
  includeAllIaC: ${{ parameters.IncludeAllIaC }}
  # Pool configuration variables - using your managed DevOps pool
  poolName: 'ai-on-edge-managed-pool'
  vmImage: 'ubuntu-24.04'

# Define the default pool for the entire pipeline using your managed DevOps pool
pool:
  name: $(poolName)

stages:
  # Daily scheduled build to run security and update scanning
  - stage: Scheduled
    displayName: Security and Updates Scanning
    condition: or(eq(variables.isScheduled, true), eq(${{ parameters.RunSecurityUpdateScanning }}, true))
    jobs:
      # SHA dependency staleness monitoring
      - template: .azdo/templates/sha-staleness-template.yml
        parameters:
          dependsOn: []
          displayName: "SHA Staleness Check"
          condition: succeeded()
          maxAgeDays: 30
          outputPath: '$(Agent.TempDirectory)/stale-dependencies.json'
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

      # OSSF Scorecard analysis for supply chain security
      - template: .azdo/templates/ossf-scorecard-template.yml
        parameters:
          dependsOn: []
          displayName: "OSSF Scorecard Analysis"
          condition: succeeded()
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

      # Use the aio-version-checker-template.yml template for checking AIO component versions
      - template: .azdo/templates/aio-version-checker-template.yml
        parameters:
          dependsOn: []
          displayName: "AIO Version Check"
          condition: succeeded()
          iacType: all  # Check all supported file types (currently only Terraform and Bicep files)
          breakBuild: false  # Only show warnings by default
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

      # Use the matrix-folder-check-template.yml to check all folders in src directory for scheduled scans
      - template: .azdo/templates/matrix-folder-check-template.yml
        parameters:
          jobName: ScheduledComponentsFolderCheck  # Unique job name for scheduled instance
          dependsOn: []
          displayName: "Check all folders in src directory"
          condition: succeeded()
          includeAllIaC: true  # Check all IaC folders for scheduled builds
          includeAllApplications: true  # Check all application folders for scheduled builds
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

      # Use the cluster-test-terraform-template.yml template for Terraform testing in scheduled runs
      - template: .azdo/templates/cluster-test-terraform-template.yml
        parameters:
          dependsOn: ScheduledComponentsFolderCheck
          displayName: "Scheduled Terraform Component Test"
          condition: eq(dependencies.ScheduledComponentsFolderCheck.outputs['matrixBuildFolderCheckTask.changesInTfInstall'], 'true')
          matrixVariable: dependencies.ScheduledComponentsFolderCheck.outputs['matrixBuildFolderCheckTask.changedTfFolders']
          azureServiceConnection: azdo-ai-for-edge-iac-for-edge
          breakBuild: true
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

  - stage: Main
    displayName: Main Build
    # Run the main build process only if the build is not scheduled and is the dev branch
    condition: and(eq(variables.isMain, true), eq(variables.isScheduled, false))
    jobs:
      # Use the megaLinter-template.yml to run MegaLinter
      - template: .azdo/templates/megalinter-template.yml
        parameters:
          dependsOn: []
          displayName: "Run MegaLinter"
          condition: succeeded()
          # for main do not report results as there's no PR to report to
          enableAzureReporter: false
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

      # Use the wiki-update-template.yml to update the wiki documentation
      # This job will only run if the MegaLinter job passes.
      - template: .azdo/templates/wiki-update-template.yml
        parameters:
          dependsOn: MegaLinter
          displayName: "Wiki Documentation Update"
          condition: succeeded()
          branchRepoFolder: "branch"
          wikiRepoFolder: "wiki"
          wikiRepo: "git://edge-ai/edge-ai@refs/heads/wiki"
          wikiBranch: "wiki"
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

  - stage: PreRelease
    displayName: Pre-Release Build
    # Run the pre-release build process only if the build is not scheduled and is the pre-release branch
    condition: and(eq(variables.isPreRelease, true), eq(variables.isScheduled, false))
    jobs:
      # Use the megaLinter-template.yml to run MegaLinter
      - template: .azdo/templates/megalinter-template.yml
        parameters:
          dependsOn: []
          displayName: "Run MegaLinter"
          condition: succeeded()
          # for main do not report results as there's no PR to report to
          enableAzureReporter: false
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)

  - stage: PR
    displayName: PR Build Process
    # Run the PR build process only if the build is not scheduled, not the dev branch and not the pre-release branch
    condition: and(eq(variables.isMain, false), eq(variables.isPreRelease, false), eq(variables.isScheduled, false))
    jobs:
      # Use the MegaLinter template for PR builds with Azure reporter enabled
      - template: .azdo/templates/megalinter-template.yml
        parameters:
          dependsOn: []
          displayName: "Run MegaLinter"
          condition: succeeded()
          # for PR builds, enable the Azure reporter to report results
          # to the PR and set the pull request ID and source repo URIs
          enableAzureReporter: true
          pullRequestId: $(System.PullRequest.PullRequestId)
          pullRequestIdOverride: $(pullRequestIdOverride)
          sourceRepoUri: $(System.PullRequest.SourceRepositoryURI)
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use the matrix-folder-check-template.yml to check for changes in src directory
      # This job runs early to provide change detection outputs for conditional execution
      - template: .azdo/templates/matrix-folder-check-template.yml
        parameters:
          jobName: ComponentChangesFolderCheck  # Add unique job name for this instance
          dependsOn: MegaLinter
          displayName: "Check for changes in src directory"
          condition: succeeded()
          includeAllIaC: ${{ parameters.IncludeAllIaC }}
          includeAllApplications: ${{ parameters.IncludeAllApplications }}
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use the enhanced documentation validation template for comprehensive docs checking
      # Note: For performance optimization in large repositories, you can use:
      # onlyChangedFiles: true (validates only files changed in PR)
      # breakBuild: true (fail build on validation issues)
      - template: .azdo/templates/docs-validation-template.yml
        parameters:
          dependsOn: ComponentChangesFolderCheck
          displayName: "Enhanced Documentation Validation"
          condition: succeeded()
          breakBuild: true  # Fail build on documentation issues
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use the docs check template for PR builds
      - template: .azdo/templates/docs-check-terraform-template.yml
        parameters:
          dependsOn: ComponentChangesFolderCheck
          displayName: "Terraform Documentation Quality Check"
          condition: eq(dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changesInTfInstall'], 'true')
          breakBuild: true  # Fail build on documentation issues
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use the docs check template for Bicep files
      - template: .azdo/templates/docs-check-bicep-template.yml
        parameters:
          dependsOn: ComponentChangesFolderCheck
          displayName: "Bicep Documentation Quality Check"
          condition: eq(dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changesInBicepInstall'], 'true')
          breakBuild: true  # Fail build on documentation issues
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use the resource-provider-pwsh-tests-template.yml template for Resource Provider testing jobs
      - template: .azdo/templates/resource-provider-pwsh-tests-template.yml
        parameters:
          dependsOn: ComponentChangesFolderCheck  # Updated to reference the unique job name
          pwshScriptCondition: eq(dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changesInRpEnablementPwsh'], 'true')
          azureServiceConnection: azdo-ai-for-edge-iac-for-edge
          workingDirectory: $(System.DefaultWorkingDirectory)/src/azure-resource-providers
          pwshTestResultsOutput: $(System.DefaultWorkingDirectory)/PWSH-TEST-RESULTS.xml
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use template for Terraform variable compliance checking
      - template: .azdo/templates/variable-compliance-terraform-template.yml
        parameters:
          dependsOn: ComponentChangesFolderCheck  # Updated to reference the unique job name
          displayName: "Check Terraform Variable Consistency"
          condition: eq(dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changesInTfInstall'], 'true')
          breakBuild: false  # Only show warnings by default
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use template for Bicep variable compliance checking
      - template: .azdo/templates/variable-compliance-bicep-template.yml
        parameters:
          dependsOn: ComponentChangesFolderCheck  # Updated to reference the unique job name
          displayName: "Check Bicep Variable Consistency"
          condition: eq(dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changesInBicepInstall'], 'true')
          breakBuild: false  # Only show warnings by default
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use the cluster-test-terraform-template.yml template for Terraform testing
      - template: .azdo/templates/cluster-test-terraform-template.yml
        parameters:
          dependsOn: ComponentChangesFolderCheck
          displayName: "Terraform Component Test"
          condition: eq(dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changesInTfInstall'], 'true')
          matrixVariable: dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changedTfFolders']
          azureServiceConnection: azdo-ai-for-edge-iac-for-edge
          breakBuild: true
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
      # Use the application-build-template.yaml template for Application builds
      - template: .azdo/templates/application-build-template.yaml
        parameters:
          dependsOn: ComponentChangesFolderCheck
          displayName: "Application Matrix Build"
          condition: or(eq(dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changesInApplications'], 'true'), eq(variables.includeAllApplications, 'True'))
          matrixVariable: dependencies.ComponentChangesFolderCheck.outputs['matrixBuildFolderCheckTask.changedApplicationFolders']
          breakBuild: true
          agentPool:
            name: $(poolName)
            vmImage: $(vmImage)
